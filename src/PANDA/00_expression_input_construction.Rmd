---
title: "00_spliting_pseudobulk"
author: "Tabea M. Soelter"
date: "2023-11-07"
output: html_document
---

```{r}
set.seed(2178)
library(purrr)
library(Matrix)
library(lintr)
library(styler)
library(here)
ptm <- proc.time()
```

#load in all data of interest as a list
```{r}
# Setting the common directory path (each user will need to update this)
common_path <- "/data/user/jbarham3/230418_TS_AgingCCC/data/pseudobulk/"

# Listing out the file names of interest
file_names <- c(
  "astrocytes.rds",
  "microglia.rds",
  "oligodendrocytes.rds",
  "opcs.rds",
  "excitatory_neurons.rds",
  "inhibitory_neurons.rds"
)

# Combining the common path with file names
file_paths <- file.path(common_path, file_names)

# Using purrr::map to load the .rds files into a list
expression_list <- map(file_paths, ~ readRDS(.x))


# Create a new list to convert the dgCMatrix to data frames
data_frame_list <- list()

# Convert each dgCMatrix to a data frame and store in data_frame_list
for (matrix in expression_list) {
  # Convert the dgCMatrix to a regular matrix
  matrix_data <- as(matrix, "matrix")

  # Convert the matrix to a data frame
  data_frame <- as.data.frame(matrix_data)

  # Append the data frame to the list
  data_frame_list <- append(data_frame_list, list(data_frame))
}

# Setting the names of the list elements to match the variable names
names(data_frame_list) <- tools::file_path_sans_ext(file_names)

# Fixing the column names to remove everything before the Sample Name
data_frame_list <- lapply(data_frame_list, function(df) {
  colnames(df) <- sub(".*_S", "S", colnames(df))
  df
})
```

#load in sample sheet
```{r}
sample_sheet <- readRDS("/data/user/jbarham3/230418_TS_AgingCCC/doc/sample_sheet.rds")
```

#using data in the sample sheet subset each cell type for each specific time point by condition and place into a new dataframe within a list
```{r}
# Setting the common directory path (each user will need to update this)
common_path <- "/data/user/jbarham3/230418_TS_AgingCCC/data/pseudobulk_split/"

# Creating a list to store the new data frames
timepoint_expression_list <- list()

# Defining the time points and column subsets
time_points <- c("WT6", "WT12", "AD6", "AD12")
column_subsets <- list(
  WT6 = c("S03", "S07", "S11"),
  WT12 = c("S04", "S08", "S12"),
  AD6 = c("S01", "S05", "S09"),
  AD12 = c("S02", "S06", "S10")
)

# Loop through the list of data frames
for (object_name in names(data_frame_list)) {
  current_df <- data_frame_list[[object_name]]

  # Loop through the time points and create new data frames
  for (time_point in time_points) {
    current_columns <- column_subsets[[time_point]]

    new_df <- current_df[, current_columns, drop = FALSE]
    new_name <- paste0(object_name, "_", time_point)
    timepoint_expression_list[[new_name]] <- new_df

    # Save the new data frame as a .Rdata object
    save(new_df, file = file.path(common_path, paste0(new_name, ".Rdata")))
  }
}
```

```{r processing-time}
fptm <- proc.time() - ptm
fptm[3] / 60
```
elapsed 
0.02325

```{r style-file}
# run style
style_file(here("src/PANDA/00_expression_input_construction.Rmd")) # commented out after being run once
# lintr was run as well
```

```{r}
sessionInfo()
```
R version 4.2.3 (2023-03-15)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 22.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C               LC_TIME=en_US.UTF-8       
 [4] LC_COLLATE=en_US.UTF-8     LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                  LC_ADDRESS=C              
[10] LC_TELEPHONE=C             LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] here_1.0.1   styler_1.9.1 lintr_3.0.2  Matrix_1.5-4 purrr_1.0.1 

loaded via a namespace (and not attached):
 [1] compiler_4.2.3    R.methodsS3_1.8.2 R.utils_2.12.2    remotes_2.4.2    
 [5] tools_4.2.3       digest_0.6.31     evaluate_0.20     lifecycle_1.0.3  
 [9] lattice_0.21-8    R.cache_0.16.0    rlang_1.1.0       rex_1.2.1        
[13] cli_3.6.1         rstudioapi_0.14   yaml_2.3.7        xfun_0.38        
[17] cyclocomp_1.1.0   fastmap_1.1.1     withr_2.5.0       knitr_1.42       
[21] xml2_1.3.3        desc_1.4.2        vctrs_0.6.2       rprojroot_2.0.3  
[25] grid_4.2.3        glue_1.6.2        R6_2.5.1          processx_3.8.1   
[29] rmarkdown_2.21    callr_3.7.3       magrittr_2.0.3    ps_1.7.5         
[33] htmltools_0.5.5   lazyeval_0.2.2    crayon_1.5.2      R.oo_1.25.0

